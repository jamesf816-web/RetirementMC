# inputs_layout.py
import copy
from dash import html
from dash import dcc
#from dash.exceptions import PreventUpdate
import dash_ag_grid as dag
#from models import PlannerInputs
from config.default_portfolio import accounts as default_accounts
from config.default_setup import default_setup

DEFAULT_ACCOUNTS = copy.deepcopy(default_accounts) # makes a deep copy
DEFAULT_SETUP = copy.deepcopy(default_setup) # makes a deep copy

def create_inputs_layout():
    return html.Div(
        style={'fontFamily': 'Arial, sans-serif', 'margin': '2%', 'backgroundColor': '#f9f9fb'},
        children=[
            html.H1(
                "Retirement Monte Carlo Explorer",
                style={'textAlign': 'center', 'color': 'black', 'marginBottom': 0}
            ),

            # add stores for default portfolio and setup inputs
            dcc.Store(id='portfolio-store', data=DEFAULT_ACCOUNTS),
            dcc.Store(id='setup-store', data=DEFAULT_SETUP),

            # ----------------------------------------------------------------------
            # ROW 1: Simulation Controls - Portfolio Editor, Slider and Run Button
            # The three items are side-by-side using Flexbox.
            # ----------------------------------------------------------------------

            html.Div([
                # COLUMN 1A: COLLAPSIBLE PORTFOLIO EDITOR
                html.Button(
                    "Portfolio Editor – Click to Open/Close",
                    id="portfolio-collapse-button",
                    n_clicks=0,
                    style={
                        'padding': '12px 20px',
                        'fontSize': '16px',
                        'fontWeight': 'bold',
                        'backgroundColor': 'purple',
                        'color': 'white',
                        'border': 'none',
                        'borderRadius': '8px',
                        'cursor': 'pointer',
                        'boxShadow': '0 4px 8px rgba(0,0,0,0.1)',
                        'whiteSpace': 'nowrap',
                        'height': '50px',
                        'alignSelf': 'flex-end',
                        'marginRight': '20px'
                    }
                ),

                # COLUMN 1B: Slider (takes up most of the space via flexGrow: 3)
                html.Div([
                    html.Label("Number of Simulations", style={'fontSize': 16, 'fontWeight': 'bold'}),
                    dcc.Slider(
                        id='nsims', min=100, max=30000, step=1000, value=1000,
                        marks={i: f"{i//1000}k" for i in range(0, 31000, 5000)},
                        tooltip={"placement": "bottom", "always_visible": True},
                    ),
                ], style={'flex': 1, 'minWidth': '300px', 'padding': '0 20px'}), 

                # COLUMN 1C: Run Button 
                html.Div([
                    html.Button(
                        "Run Simulation",
                        id="run",
                        n_clicks=0,
                        style={
                            'marginTop': '30px',
                            'width': '100%',
                            'height': '50px',
                            'fontSize': 16, 
                            'backgroundColor': '#3498db',
                            'color': 'white', 
                            'border': 'none',
                            'borderRadius': '8px',
                            'alignSelf': 'flex-end',
                            'marginBottom': '2px'
                        }
                    ),
                ], style={'Width': '160px'}),

                # COLUMN 1D: COLLAPSIBLE SETUP EDITOR
                html.Button(
                    "Setup Editor – Click to Open/Close",
                    id="setup-collapse-button",
                    n_clicks=0,
                    style={
                        'padding': '12px 20px',
                        'fontSize': '16px',
                        'fontWeight': 'bold',
                        'backgroundColor': 'purple',
                        'color': 'white',
                        'border': 'none',
                        'borderRadius': '8px',
                        'cursor': 'pointer',
                        'boxShadow': '0 4px 8px rgba(0,0,0,0.1)',
                        'whiteSpace': 'nowrap',
                        'height': '50px',
                        'alignSelf': 'flex-end',
                        'marginRight': '20px'
                    }
                )       
            ], style={
                'display': 'flex',        # ROW 1: Enable Flexbox
                'alignItems': 'flex-end', # Vertically aligns items to the bottom (makes the button align with the slider's track)
                'gap': '15px',            # gaps between items
                'marginBottom': '20px',   # Space below the first row
                'flexWrap': 'wrap',       # Allows wrapping on small screens
                'width': '100%',
                'boxSizing': 'border-box'
            }),


            # COLLAPSIBLE PORTFOLIO EDITOR FULL WIDTH WHEN OPEN
            # This Div shows/hides based on CSS (starts hidden)
            html.Div(
                id="portfolio-collapse-content",
                style={'display': 'none'},  # ← starts closed
                children=[
                    html.Div([
                        html.Div([
                            html.Button("Add New Account", id="add-account-btn", n_clicks=0,
                                        style={'marginRight': '10px', 'backgroundColor': '#27ae60', 'color': 'white', 'border': 'none', 'padding': '10px 20px', 'borderRadius': '4px'}),
                            html.Button("Reset to Defaults", id="reset-portfolio-btn", n_clicks=0,
                                        style={'backgroundColor': '#e74c3c', 'color': 'white', 'border': 'none', 'padding': '10px 20px', 'borderRadius': '4px'}),
                            html.Div(id="portfolio-status", style={'display': 'inline-block', 'marginLeft': '20px', 'color': '#7f8c8d', 'fontSize': '14px'})
                        ], style={'marginBottom': '15px', 'display': 'flex', 'alignItems': 'center'}),

                        dag.AgGrid(
                            id='portfolio-grid',
                            columnDefs=[
                                {"field": "name", "headerName": "Account Name", "editable": False, "pinned": "left", "width": 180},
                                {"field": "balance", "headerName": "Balance ($)", "type": "rightAligned",
                                 "valueFormatter": {"function": "params.value == null ? '' : '$' + Number(params.value).toLocaleString()"},
                                 "editable": True},
                                {"field": "equity", "headerName": "Equity %",
                                 "valueFormatter": {"function": "params.value == null ? '' : (params.value*100).toFixed(1) + '%'"},
                                 "editable": True},
                                {"field": "bond", "headerName": "Bond %",
                                 "valueFormatter": {"function": "params.value == null ? '' : (params.value*100).toFixed(1) + '%'"},
                                 "editable": True},
                                {"field": "tax", "headerName": "Tax Type", "cellEditor": "agSelectCellEditor",
                                 "cellEditorParams": {"values": ["taxable", "traditional", "roth", "inherited", "trust"]}, "width": 130},
                                {"field": "owner", "headerName": "Owner", "cellEditor": "agSelectCellEditor",
                                 "cellEditorParams": {"values": ["person1", "person2"]}, "width": 110},
                                {"field": "basis", "headerName": "Basis ($)",
                                 "valueFormatter": {"function": "params.value == null ? '' : '$' + Number(params.value).toLocaleString()"},
                                 "editable": True},
                                {"field": "mandatory_yield", "headerName": "Mand. Yield", "editable": True, "width": 110},
                                {"field": "rmd_factor_table", "headerName": "RMD Table", "editable": True, "width": 130},
                                {
                                    "headerName": "Delete",
                                    "cellRenderer": "btnCellRenderer",
                                    "cellRendererParams": {"clickedField": "delete"},
                                    "width": 90,
                                    "pinned": "right",
                                    "sortable": False,
                                    "filter": False
                                },
                            ],
                            rowData=[{**v, "name": k} for k, v in DEFAULT_ACCOUNTS.items()],
                            defaultColDef={
                                "flex": 1,
                                "minWidth": 100,
                                "resizable": True,
                                "sortable": True,
                                "filter": True,
                                "floatingFilter": True
                            },
                            dashGridOptions={"rowHeight": 48, "animateRows": False},
                            style={"height": 550},
                            className="ag-theme-alpine",
                        )
                    ], style={
                        'padding': '25px',
                        'border': '2px solid #ddd',
                        'borderRadius': '12px',
                        'backgroundColor': '#fff',
                        'boxShadow': '0 8px 25px rgba(0,0,0,0.1)',
                        'marginBottom': '30px'
                    })
                ]
            ),

            # ----------------------------------------------------------------------
            # ROW 2: Inputs and Dropdowns (5 Items: Input, Input, Input, Dropdown, Dropdown)
            # Total of 5 items are laid out horizontally using Flexbox and gap.
            # ----------------------------------------------------------------------
            html.Div([

                # Item 2A: Base Spending (Input)
                html.Div([
                    html.Label("Base Spending", style={'fontWeight': 'bold'}),
                    dcc.Input(id='base_annual_spending', type="number", value=140000, step=5000,
                              style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
                ], style={'flex': '1', 'minWidth': '140px', 'textAlign': 'center'}), # Widths total 100% across the 7 items (14% each)

                # Item 2B: Withdrawal Rate (Input)
                html.Div([
                    html.Label("Withdrawal Rate", style={'fontWeight': 'bold'}),
                    dcc.Input(id='withdrawal_rate', type="number", value=0.050, step=0.001,
                              style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
                ], style={'flex': '1', 'minWidth': '150px', 'textAlign': 'center'}),

                # Item 2C: Max Roth Conv (Input)
                html.Div([
                    html.Label("Max Roth Conv", style={'fontWeight': 'bold'}),
                    dcc.Input(id='max_roth', type="number", value=240000, step=5000,
                              style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
                ], style={'flex': '1', 'minWidth': '150px', 'textAlign': 'center'}),

                # Item 2D: Target Travel (Input)
                html.Div([
                    html.Label("Target Travel", style={'fontWeight': 'bold'}),
                    dcc.Input(id='travel', type="number", value=50000, step=1000,
                              style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
                ], style={'flex': '1', 'minWidth': '120px', 'textAlign': 'center'}),

                # Item 2E: Target Gifting (Input)
                html.Div([
                    html.Label("Target Gifting", style={'fontWeight': 'bold'}),
                    dcc.Input(id='gifting', type="number", value=42000, step=1000,
                              style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
                ], style={'flex': '1', 'minWidth': '120px', 'textAlign': 'center'}),

                # Item 2F: Tax Strategy (Dropdown)
                html.Div([
                    html.Label("Tax Strategy", style={'fontWeight': 'bold'}),
                    dcc.Dropdown(
                        id='tax_strategy',
                        options=[
                            {'label': 'Fill 22% bracket ($211k)', 'value': 'fill_22_percent'},
                            {'label': 'Fill 24% bracket ($404k)', 'value': 'fill_24_percent'},
                            {'label': 'Fill 32% bracket ($512k)', 'value': 'fill_32_percent'},
                            {'label': 'Fill 35% bracket ($767k)', 'value': 'fill_35_percent'},
                            {'label': 'No conversions', 'value': 'none'},
                        ],
                        value='fill_24_percent',
                        style={'fontSize': 16, 'height': '30px', 'lineHeight': '20px', 'textAlign': 'center'}
                    )
                ], style={'flex': '3', 'minWidth': '260px', 'textAlign': 'center'}),

                # Item 2G: IRMAA Strategy (Dropdown)
                html.Div([
                    html.Label("IRMAA Strategy", style={'fontWeight': 'bold'}),
                    dcc.Dropdown(
                        id='irmaa_strategy',
                        options=[
                            {'label': 'Stay under Tier 0 ($218k)', 'value': 'fill_IRMAA_0'},
                            {'label': 'Stay under Tier 1 ($274k)', 'value': 'fill_IRMAA_1'},
                            {'label': 'Stay under Tier 2 ($342k)', 'value': 'fill_IRMAA_2'},
                            {'label': 'Stay under Tier 3 ($410k)', 'value': 'fill_IRMAA_3'},
                            {'label': 'Stay under Tier 4 ($750k)', 'value': 'fill_IRMAA_4'},
                        ],
                        value='fill_IRMAA_3',
                        style={'fontSize': 16, 'height': '30px', 'lineHeight': '20px', 'textAlign': 'center'}
                    )
                ], style={'flex': '3', 'minWidth': '260px', 'textAlign': 'center'}),
            ], style={
                'display': 'flex',    # ROW 2: Enable Flexbox
                'gap': '15px',        # Adds a 15px gutter between all five items
                'flexWrap': 'wrap',
                'marginBottom': '30px',
                'width': '100%',
                'boxSizing': 'border-box'
            }), # closes row 2

            # ----------------------------------------------------------------------
            # COLLAPSIBLE SETUP EDITOR FULL WIDTH WHEN OPEN
            # ----------------------------------------------------------------------

            html.Div(
                id="setup-collapse-content",
                style={'display': 'none'},  # starts closed
                children=[
                    html.Div([
                        html.H3("Simulation Setup Parameters", style={'marginBottom': '20px'}),
                        dag.AgGrid(
                            id='setup-grid',
                            columnDefs=[
                                {"field": "parameter", "headerName": "Parameter", "editable": False, "pinned": "left", "width": 280},
                                {"field": "value",      "headerName": "Value",      "editable": True, "type": "rightAligned"},
                            ],
                            rowData=DEFAULT_SETUP,
                            defaultColDef={
                                "flex": 1,
                                "minWidth": 150,
                                "resizable": True,
                                "sortable": True,
                                "filter": True,
                                "floatingFilter": True,
                            },
                            dashGridOptions={"rowHeight": 42},
                            style={"height": 600},
                            className="ag-theme-alpine",
                        ),
                    ], style={
                        'padding': '25px',
                        'border': '2px solid #ddd',
                        'borderRadius': '12px',
                        'backgroundColor': '#fff',
                        'boxShadow': '0 8px 25px rgba(0,0,0,0.1)',
                        'marginBottom': '30px'
                    })
                ]
            ),

            # Loading spinner + Results area
            dcc.Loading(
                id="loading",
                type="circle",
                children=html.Div(id="results-container")
            ),

            # Hidden debug
            html.Div(id="debug-output", style={"whiteSpace": "pre-wrap", "fontSize": 12, "display": "none"}),
        ] 
    ) 


