# app.py
from dash import Dash, html, Input, Output, State, callback, ctx
from dash import dcc
from dash.exceptions import PreventUpdate

import dash_ag_grid as dag
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd
import numpy as np
import time
import copy

from models import PlannerInputs
from engine.simulator import RetirementSimulator
from config.default_portfolio import accounts as default_accounts
from config.default_setup import default_setup
from config.expense_assumptions import *
from config.market_assumptions import *

DEFAULT_ACCOUNTS = copy.deepcopy(default_accounts) # makes a deep copy
DEFAULT_SETUP = copy.deepcopy(default_setup) # makes a deep copy

app = Dash(__name__, assets_folder="assets")

app.layout = html.Div(
    style={'fontFamily': 'Arial, sans-serif', 'margin': '2%', 'backgroundColor': '#f9f9fb'},
    children=[
        html.H1(
            "Retirement Monte Carlo Explorer",
            style={'textAlign': 'center', 'color': 'black', 'marginBottom': 0}
        ),

        # add stores for default portfolio and setup inputs
        dcc.Store(id='portfolio-store', data=DEFAULT_ACCOUNTS),
        dcc.Store(id='setup-store', data=DEFAULT_SETUP),

        # ----------------------------------------------------------------------
        # ROW 1: Simulation Controls - Portfolio Editor, Slider and Run Button
        # The three items are side-by-side using Flexbox.
        # ----------------------------------------------------------------------

        html.Div([
            # COLUMN 1A: COLLAPSIBLE PORTFOLIO EDITOR
            html.Button(
                "Portfolio Editor – Click to Open/Close",
                id="portfolio-collapse-button",
                n_clicks=0,
                style={
                    'padding': '12px 20px',
                    'fontSize': '16px',
                    'fontWeight': 'bold',
                    'backgroundColor': 'purple',
                    'color': 'white',
                    'border': 'none',
                    'borderRadius': '8px',
                    'cursor': 'pointer',
                    'boxShadow': '0 4px 8px rgba(0,0,0,0.1)',
                    'whiteSpace': 'nowrap',
                    'height': '50px',
                    'alignSelf': 'flex-end',
                    'marginRight': '20px'
                }
            ),

            # COLUMN 1B: Slider (takes up most of the space via flexGrow: 3)
            html.Div([
                html.Label("Number of Simulations", style={'fontSize': 16, 'fontWeight': 'bold'}),
                dcc.Slider(
                    id='nsims', min=100, max=30000, step=1000, value=1000,
                    marks={i: f"{i//1000}k" for i in range(0, 31000, 5000)},
                    tooltip={"placement": "bottom", "always_visible": True},
                ),
            ], style={'flex': 1, 'minWidth': '300px', 'padding': '0 20px'}), 

            # COLUMN 1C: Run Button 
            html.Div([
                html.Button(
                    "Run Simulation",
                    id="run",
                    n_clicks=0,
                    style={
                        'marginTop': '30px',
                        'width': '100%',
                        'height': '50px',
                        'fontSize': 16, 
                        'backgroundColor': '#3498db',
                        'color': 'white', 
                        'border': 'none',
                        'borderRadius': '8px',
                        'alignSelf': 'flex-end',
                        'marginBottom': '2px'
                    }
                ),
            ], style={'Width': '160px'}),

            # COLUMN 1D: COLLAPSIBLE SETUP EDITOR
            html.Button(
                "Setup Editor – Click to Open/Close",
                id="setup-collapse-button",
                n_clicks=0,
                style={
                    'padding': '12px 20px',
                    'fontSize': '16px',
                    'fontWeight': 'bold',
                    'backgroundColor': 'purple',
                    'color': 'white',
                    'border': 'none',
                    'borderRadius': '8px',
                    'cursor': 'pointer',
                    'boxShadow': '0 4px 8px rgba(0,0,0,0.1)',
                    'whiteSpace': 'nowrap',
                    'height': '50px',
                    'alignSelf': 'flex-end',
                    'marginRight': '20px'
                }
            )       
        ], style={
            'display': 'flex',        # ROW 1: Enable Flexbox
            'alignItems': 'flex-end', # Vertically aligns items to the bottom (makes the button align with the slider's track)
            'gap': '15px',            # gaps between items
            'marginBottom': '20px',   # Space below the first row
            'flexWrap': 'wrap',       # Allows wrapping on small screens
            'width': '100%',
            'boxSizing': 'border-box'
        }),


        # COLLAPSIBLE PORTFOLIO EDITOR FULL WIDTH WHEN OPEN
        # This Div shows/hides based on CSS (starts hidden)
        html.Div(
            id="portfolio-collapse-content",
            style={'display': 'none'},  # ← starts closed
            children=[
                html.Div([
                    html.Div([
                        html.Button("Add New Account", id="add-account-btn", n_clicks=0,
                                    style={'marginRight': '10px', 'backgroundColor': '#27ae60', 'color': 'white', 'border': 'none', 'padding': '10px 20px', 'borderRadius': '4px'}),
                        html.Button("Reset to Defaults", id="reset-portfolio-btn", n_clicks=0,
                                    style={'backgroundColor': '#e74c3c', 'color': 'white', 'border': 'none', 'padding': '10px 20px', 'borderRadius': '4px'}),
                        html.Div(id="portfolio-status", style={'display': 'inline-block', 'marginLeft': '20px', 'color': '#7f8c8d', 'fontSize': '14px'})
                    ], style={'marginBottom': '15px', 'display': 'flex', 'alignItems': 'center'}),

                    dag.AgGrid(
                        id='portfolio-grid',
                        columnDefs=[
                            {"field": "name", "headerName": "Account Name", "editable": False, "pinned": "left", "width": 180},
                            {"field": "balance", "headerName": "Balance ($)", "type": "rightAligned",
                             "valueFormatter": {"function": "params.value == null ? '' : '$' + Number(params.value).toLocaleString()"},
                             "editable": True},
                            {"field": "equity", "headerName": "Equity %",
                             "valueFormatter": {"function": "params.value == null ? '' : (params.value*100).toFixed(1) + '%'"},
                             "editable": True},
                            {"field": "bond", "headerName": "Bond %",
                             "valueFormatter": {"function": "params.value == null ? '' : (params.value*100).toFixed(1) + '%'"},
                             "editable": True},
                            {"field": "tax", "headerName": "Tax Type", "cellEditor": "agSelectCellEditor",
                             "cellEditorParams": {"values": ["taxable", "traditional", "roth", "inherited", "trust"]}, "width": 130},
                            {"field": "owner", "headerName": "Owner", "cellEditor": "agSelectCellEditor",
                             "cellEditorParams": {"values": ["person1", "person2"]}, "width": 110},
                            {"field": "basis", "headerName": "Basis ($)",
                             "valueFormatter": {"function": "params.value == null ? '' : '$' + Number(params.value).toLocaleString()"},
                             "editable": True},
                            {"field": "mandatory_yield", "headerName": "Mand. Yield", "editable": True, "width": 110},
                            {"field": "rmd_factor_table", "headerName": "RMD Table", "editable": True, "width": 130},
                            {
                                "headerName": "Delete",
                                "cellRenderer": "btnCellRenderer",
                                "cellRendererParams": {"clickedField": "delete"},
                                "width": 90,
                                "pinned": "right",
                                "sortable": False,
                                "filter": False
                            },
                        ],
                        rowData=[{**v, "name": k} for k, v in DEFAULT_ACCOUNTS.items()],
                        defaultColDef={
                            "flex": 1,
                            "minWidth": 100,
                            "resizable": True,
                            "sortable": True,
                            "filter": True,
                            "floatingFilter": True
                        },
                        dashGridOptions={"rowHeight": 48, "animateRows": False},
                        style={"height": 550},
                        className="ag-theme-alpine",
                    )
                ], style={
                    'padding': '25px',
                    'border': '2px solid #ddd',
                    'borderRadius': '12px',
                    'backgroundColor': '#fff',
                    'boxShadow': '0 8px 25px rgba(0,0,0,0.1)',
                    'marginBottom': '30px'
                })
            ]
        ),

        # ----------------------------------------------------------------------
        # ROW 2: Inputs and Dropdowns (5 Items: Input, Input, Input, Dropdown, Dropdown)
        # Total of 5 items are laid out horizontally using Flexbox and gap.
        # ----------------------------------------------------------------------
        html.Div([

            # Item 2A: Base Spending (Input)
            html.Div([
                html.Label("Base Spending", style={'fontWeight': 'bold'}),
                dcc.Input(id='base_annual_spending', type="number", value=140000, step=5000,
                          style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
            ], style={'flex': '1', 'minWidth': '140px', 'textAlign': 'center'}), # Widths total 100% across the 7 items (14% each)

            # Item 2B: Withdrawal Rate (Input)
            html.Div([
                html.Label("Withdrawal Rate", style={'fontWeight': 'bold'}),
                dcc.Input(id='withdrawal_rate', type="number", value=0.050, step=0.001,
                          style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
            ], style={'flex': '1', 'minWidth': '150px', 'textAlign': 'center'}),

            # Item 2C: Max Roth Conv (Input)
            html.Div([
                html.Label("Max Roth Conv", style={'fontWeight': 'bold'}),
                dcc.Input(id='max_roth', type="number", value=240000, step=5000,
                          style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
            ], style={'flex': '1', 'minWidth': '150px', 'textAlign': 'center'}),

            # Item 2D: Target Travel (Input)
            html.Div([
                html.Label("Target Travel", style={'fontWeight': 'bold'}),
                dcc.Input(id='travel', type="number", value=50000, step=1000,
                          style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
            ], style={'flex': '1', 'minWidth': '120px', 'textAlign': 'center'}),

            # Item 2E: Target Gifting (Input)
            html.Div([
                html.Label("Target Gifting", style={'fontWeight': 'bold'}),
                dcc.Input(id='gifting', type="number", value=42000, step=1000,
                          style={'width': '100%', 'fontSize': 16, 'height': '30px', 'textAlign': 'center'})
            ], style={'flex': '1', 'minWidth': '120px', 'textAlign': 'center'}),

            # Item 2F: Tax Strategy (Dropdown)
            html.Div([
                html.Label("Tax Strategy", style={'fontWeight': 'bold'}),
                dcc.Dropdown(
                    id='tax_strategy',
                    options=[
                        {'label': 'Fill 22% bracket ($211k)', 'value': 'fill_22_percent'},
                        {'label': 'Fill 24% bracket ($404k)', 'value': 'fill_24_percent'},
                        {'label': 'Fill 32% bracket ($512k)', 'value': 'fill_32_percent'},
                        {'label': 'Fill 35% bracket ($767k)', 'value': 'fill_35_percent'},
                        {'label': 'No conversions', 'value': 'none'},
                    ],
                    value='fill_24_percent',
                    style={'fontSize': 16, 'height': '30px', 'lineHeight': '20px', 'textAlign': 'center'}
                )
            ], style={'flex': '3', 'minWidth': '260px', 'textAlign': 'center'}),

            # Item 2G: IRMAA Strategy (Dropdown)
            html.Div([
                html.Label("IRMAA Strategy", style={'fontWeight': 'bold'}),
                dcc.Dropdown(
                    id='irmaa_strategy',
                    options=[
                        {'label': 'Stay under Tier 0 ($218k)', 'value': 'fill_IRMAA_0'},
                        {'label': 'Stay under Tier 1 ($274k)', 'value': 'fill_IRMAA_1'},
                        {'label': 'Stay under Tier 2 ($342k)', 'value': 'fill_IRMAA_2'},
                        {'label': 'Stay under Tier 3 ($410k)', 'value': 'fill_IRMAA_3'},
                        {'label': 'Stay under Tier 4 ($750k)', 'value': 'fill_IRMAA_4'},
                    ],
                    value='fill_IRMAA_3',
                    style={'fontSize': 16, 'height': '30px', 'lineHeight': '20px', 'textAlign': 'center'}
                )
            ], style={'flex': '3', 'minWidth': '260px', 'textAlign': 'center'}),
        ], style={
            'display': 'flex',    # ROW 2: Enable Flexbox
            'gap': '15px',        # Adds a 15px gutter between all five items
            'flexWrap': 'wrap',
            'marginBottom': '30px',
            'width': '100%',
            'boxSizing': 'border-box'
        }), # closes row 2

        # ----------------------------------------------------------------------
        # COLLAPSIBLE SETUP EDITOR FULL WIDTH WHEN OPEN
        # ----------------------------------------------------------------------

        html.Div(
            id="setup-collapse-content",
            style={'display': 'none'},  # starts closed
            children=[
                html.Div([
                    html.H3("Simulation Setup Parameters", style={'marginBottom': '20px'}),
                    dag.AgGrid(
                        id='setup-grid',
                        columnDefs=[
                            {"field": "parameter", "headerName": "Parameter", "editable": False, "pinned": "left", "width": 280},
                            {"field": "value",      "headerName": "Value",      "editable": True, "type": "rightAligned"},
                        ],
                        rowData=DEFAULT_SETUP,
                        defaultColDef={
                            "flex": 1,
                            "minWidth": 150,
                            "resizable": True,
                            "sortable": True,
                            "filter": True,
                            "floatingFilter": True,
                        },
                        dashGridOptions={"rowHeight": 42},
                        style={"height": 600},
                        className="ag-theme-alpine",
                    ),
                ], style={
                    'padding': '25px',
                    'border': '2px solid #ddd',
                    'borderRadius': '12px',
                    'backgroundColor': '#fff',
                    'boxShadow': '0 8px 25px rgba(0,0,0,0.1)',
                    'marginBottom': '30px'
                })
            ]
        ),

        # ----------------------------------------------------------------------
        # Loading spinner + Results area
        # ----------------------------------------------------------------------
        dcc.Loading(
            id="loading",
            type="circle",
            children=html.Div(id="results-container")
        ),

        # Hidden div to store debug log (optional)
        html.Div(id="debug-output", style={"whiteSpace": "pre-wrap", "fontSize": 12, "display": "none"}),
    ]
)

# ----------------------------------------------------------------------
# CALLBACKS
# ----------------------------------------------------------------------


#@app.callback(
#    Output("results-container", "children"),
#    Output("debug-output", "children"),
#    Input("run", "n_clicks"),
#    State("portfolio-store", "data"),
#    State("setup-grid", "rowData"),
#    State("base_annual_spending", "value"),
#    State("withdrawal_rate", "value"),
#    State("max_roth", "value"),
#    State("travel", "value"),
#    State("gifting", "value"),
#   State("nsims", "value"),
#    prevent_initial_call=True
#)
#def run_monte_carlo(n_clicks, portfolio_data, setup_rows, base_spending, withdrawal_rate,
#                    max_roth, travel, gifting, nsims):
#    if n_clicks is None:
#        raise PreventUpdate

def vanguard_color(success_rate):
    """
    Returns a color in the Vanguard-style green-to-red gradient.
    success_rate: 0 to 100
    """
    # Clamp success_rate between 0 and 100
    sr = max(0, min(100, success_rate))

    # Green to yellow to red gradient
    if sr >= 75:
        # Green gradient (high success)
        r = int(255 * (1 - (sr - 75)/25))  # decrease red
        g = 200
        b = 0
    elif sr >= 50:
        # Yellow gradient (medium success)
        r = 255
        g = int(200 * ((sr - 50)/25 + 0.5))  # ramp green
        b = 0
    else:
        # Red gradient (low success)
        r = 255
        g = int(200 * (sr/50))  # ramp green
        b = 0

    return f'rgb({r},{g},{b})'


def get_planner_inputs(portfolio_data, setup_rows):
    # Convert store/grid back to dict
    setup_dict = {row["parameter"]: row["value"] for row in setup_rows}

    # Inject portfolio data
    setup_dict["accounts"] = portfolio_data

    # Pass the dict directly to PlannerInputs
    return PlannerInputs(**setup_dict)


@app.callback(
    Output('results-container', 'children'),
    Output("debug-output", "children"),
    Input('run', 'n_clicks'),
    State('portfolio-store', 'data'),
    State('setup-store', 'data'),
    prevent_initial_call=True
)
def update_results(run, portfolio, setup):
    # Proper Dash trigger check (only run on 'run' button click)
    if ctx.triggered_id != 'run' or not run:
        raise PreventUpdate

    t0 = time.time()
    debug_log = []

    # ONE LINE: Build the typed inputs (no repetition here)
    inputs = get_planner_inputs(portfolio_data=portfolio, setup_data=setup)
    sim = RetirementSimulator(inputs)  # Pass dataclass directly (see Step 3)
    res = sim.run_simulation()
    elapsed = time.time() - t0
    
    years = res["years"]
    portfolio = res["portfolio_paths"]
    travel = res.get("travel_paths", np.zeros_like(portfolio))
    gifting = res.get("gifting_paths", np.zeros_like(portfolio))
    base_spending = res.get("base_spending_paths", np.zeros_like(portfolio))
    lumpy_spending = res.get("lumpy_spending_paths", np.zeros_like(portfolio))
    plan = res.get("plan_paths", np.zeros_like(portfolio))
    income = res.get("income_paths", np.zeros_like(portfolio))
    trust_income = res.get("trust_income_paths", np.zeros_like(portfolio))
    ssbenefit = res.get("ssbenefit_paths", np.zeros_like(portfolio))
    portfolio_withdrawal = res.get("portfolio_withdrawal_paths", np.zeros_like(portfolio))
    taxes = res.get("taxes_paths", np.zeros_like(portfolio))
    conversion = res.get("conversion_paths", np.zeros_like(portfolio))
    rmds = res.get("rmd_paths", np.zeros_like(portfolio))
    def457b_income = res.get("def457b_income_paths", np.zeros_like(portfolio))
    pension = res.get("pension_paths", np.zeros_like(portfolio))
    medicare = res.get("medicare_paths", np.zeros_like(portfolio))
    success_rate = res.get("success_rate", None)
    avoid_ruin_rate = res.get("avoid_ruin_rate", None)
    magi = res.get("magi_paths", np.zeros_like(portfolio))
      
    # === 1-3. Portfolio by Tax Type ===
    tax_type_map = {
        "def457b": "457b Deferred Salary",
        "taxable": "Taxable Brokerage",
        "trust": "Trust Accounts",
        "traditional": "Traditional IRAs",
        "inherited": "Inherited IRAs",
        "roth": "Roth IRAs"
    }
    fig1 = go.Figure()
    fig2 = go.Figure()
    fig3 = go.Figure()
    colors = px.colors.qualitative.Vivid
    i = 0
    
    for i, (tax, label) in enumerate(tax_type_map.items()):
        paths = np.zeros((sim.nsims, len(years)))
        for name, traj in res["account_paths"].items():
            if inputs.accounts[name]["tax"] == tax:
                paths += traj
        if paths.max() == 0:
                continue

        median = np.median(paths, axis=0)
        p10 = np.percentile(paths, 10, axis=0)
        p90 = np.percentile(paths, 90, axis=0)

        fig1.add_trace(go.Scatter(x=years[1:], y=median[1:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=tax))
        fig2.add_trace(go.Scatter(x=years[1:], y=p10[1:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=tax))
        fig3.add_trace(go.Scatter(x=years[1:], y=p90[1:], mode='lines', line=dict(width=0), showlegend=True,
                                   hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=tax))
 
    fig1.update_layout(
        title="Portfolio Trajectories by Tax Type (median)",
        xaxis_title="Year", yaxis_title="Balance ($)", template="plotly_white",
        hovermode="x unified", height=600, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )
    fig2.update_layout(
        title="Portfolio Trajectories by Tax Type (10% CL)",
        xaxis_title="Year", yaxis_title="Balance ($)", template="plotly_white",
        hovermode="x unified", height=400, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )
    fig3.update_layout(
        title="Portfolio Trajectories by Tax Type (90% CL)",
        xaxis_title="Year", yaxis_title="Balance ($)", template="plotly_white",
        hovermode="x unified", height=400, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )

    # === 4-6. Income Streams ===
    fig4 = go.Figure()
    fig5 = go.Figure()
    fig6 = go.Figure()
    colors = px.colors.qualitative.Plotly
    i = 0
    for name, traj in [("457b  Deferred Salary", def457b_income), ("Trust Income", trust_income), ("RMDs", rmds), ("Pension", pension), ("SS Benefit", ssbenefit), ("Portfolio Withdrawal", portfolio_withdrawal)]:
        i += 1
        median = np.median(traj, axis=0)
        p10 = np.percentile(traj, 10, axis=0)
        p90 = np.percentile(traj, 90, axis=0)

        fig4.add_trace(go.Scatter(x=years[2:], y=median[2:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=name))
        fig5.add_trace(go.Scatter(x=years[2:], y=p10[2:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=name))
        fig6.add_trace(go.Scatter(x=years[2:], y=p90[2:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=name))

    fig4.update_layout(
        title="Income Trajectories (median)",
        xaxis_title="Year", yaxis_title="income ($)", yaxis_range=[0,1_500_000], template="plotly_white",
        hovermode="x unified", height=600, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )
    fig5.update_layout(
        title="Income Trajectories (10% CL)",
        xaxis_title="Year", yaxis_title="Income ($)", template="plotly_white",
        hovermode="x unified", height=400, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )
    fig6.update_layout(
        title="Income Trajectories (90% CL)",
        xaxis_title="Year", yaxis_title="Income ($)", template="plotly_white",
        hovermode="x unified", height=400, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )


    # === 7-9. Spending ===
    fig7 = go.Figure()
    fig8 = go.Figure()
    fig9 = go.Figure()
    colors = px.colors.qualitative.Vivid
    i = 0
    median = np.median(plan, axis=0)
    p10 = np.percentile(plan, 10, axis=0)
    p90 = np.percentile(plan, 90, axis=0)

    fig7.add_trace(go.Scatter(x=years[2:], y=median[2:], fill=None, mode='lines', line=dict(color=colors[i], width=4), name="5% Spending Plan"))
    fig8.add_trace(go.Scatter(x=years[2:], y=p10[2:], fill=None, mode='lines', line_color=colors[i], name="5% Spending Plan"))
    fig9.add_trace(go.Scatter(x=years[2:], y=p90[2:], fill=None, mode='lines', line_color=colors[i], name="5% Spending Plan"))

    for name, traj in [("Base Spending", base_spending), ("Travel", travel), ("Gifting", gifting), ("Taxes", taxes), ("Lumpy Spending", lumpy_spending)]:
        if traj.max() == 0: continue
        i += 1
        median = np.median(traj, axis=0)
        p10 = np.percentile(traj, 10, axis=0)
        p90 = np.percentile(traj, 90, axis=0)
 
        fig7.add_trace(go.Scatter(x=years[2:], y=median[2:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=name))
        fig8.add_trace(go.Scatter(x=years[2:], y=p10[2:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=name))
        fig9.add_trace(go.Scatter(x=years[2:], y=p90[2:], mode='lines', line=dict(width=0), showlegend=True,
                                  hoverinfo='skip', stackgroup='one',fillcolor=colors[i],name=name))

    fig7.update_layout(
        title="Spending Trajectories (median)",
        xaxis_title="Year", yaxis_title="income ($)", yaxis_range=[0,1500000], template="plotly_white",
        hovermode="x unified", height=600, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )
    fig8.update_layout(
        title="Spending Trajectories (10% CL)",
        xaxis_title="Year", yaxis_title="Income ($)", template="plotly_white",
        hovermode="x unified", height=400, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )
    fig9.update_layout(
        title="Spending Trajectories (90% CL)",
        xaxis_title="Year", yaxis_title="Income ($)", template="plotly_white",
        hovermode="x unified", height=400, legend=dict(x=1, y=1, xanchor='right', yanchor='top', bgcolor="rgba(255,255,255,0.8)")
    )

    # === 10. MAGI ===
    median_magi = np.median(magi, axis=0)
    p10_magi = np.percentile(magi, 10, axis=0)
    p90_magi = np.percentile(magi, 90, axis=0)
    
    fig10 = go.Figure()
    fig10.add_trace(go.Scatter(x=years[2:], y=median_magi[2:], fill=None, mode='lines', line=dict(color="blue", width=4), name='median MAGI'))
    fig10.add_trace(go.Scatter(x=years[2:], y=p10_magi[2:], fill=None, mode='lines', line_color="red", name='10% CL', showlegend=True))
    fig10.add_trace(go.Scatter(x=years[2:], y=p90_magi[2:], fill=None, mode='lines', line_color="green", name = '90% CL', showlegend=True))

    fig10.update_layout(
        title="MAGI", xaxis_title="Year", yaxis=dict(title="Annual MAGI", range=[0, None]),
        template="plotly_white", hovermode="x unified", height=400
    )
 
    # === 11. Travel & Gifting ===
    fig11 = go.Figure()
    colors = px.colors.qualitative.Vivid
    i = 1
    for name, traj in [("Travel", travel), ("Gifting", gifting)]:
        if traj.max() == 0: continue
        median = np.median(traj, axis=0)
        p10 = np.percentile(traj, 10, axis=0)
        p90 = np.percentile(traj, 90, axis=0)
        fig11.add_trace(go.Scatter(x=years[2:], y=median[2:], fill=None, mode='lines', line=dict(color=colors[i], width=5), name=f'Median {name}'))
        fig11.add_trace(go.Scatter(x=years[2:], y=p10[2:], fill=None, mode='lines', line=dict(color=colors[i], width=1), name=f'10% CL {name}', showlegend=True))
        fig11.add_trace(go.Scatter(x=years[2:], y=p90[2:], fill=None, mode='lines', line=dict(color=colors[i], width=1), name=f'90% CL {name}', showlegend=True))
        i += 1

    fig11.update_layout(
        title="Travel & Gifting", xaxis_title="Year", yaxis_title="Annual Spending ($)",
        template="plotly_white", hovermode="x unified", height=400)
    
    # === 12. ROTH conversions ===
    fig12 = go.Figure()
    for name, traj in [("ROTH Convesions", conversion)]:
        if traj.max() == 0: continue
        median = np.median(traj, axis=0)
        p10 = np.percentile(traj, 10, axis=0)
        p90 = np.percentile(traj, 90, axis=0)
        fig12.add_trace(go.Scatter(x=years[2:], y=median[2:], fill=None, mode='lines', line=dict(color="blue", width=4), name=f'Median {name}'))
        fig12.add_trace(go.Scatter(x=years[2:], y=p10[2:], fill=None, mode='lines', line=dict(color="red", width=2), name=f'10% CL {name}', showlegend=True))
        fig12.add_trace(go.Scatter(x=years[2:], y=p90[2:], fill=None, mode='lines', line=dict(color="green", width=2), name=f'90% CL {name}', showlegend=True))
 
    fig12.update_layout(
        title="ROTH Conversions", xaxis_title="Year", yaxis_title="Annual Spending ($)",
        template="plotly_white", hovermode="x unified", height=400)
    
     # === 13. Medicare Costs ===
    median_med = np.median(medicare, axis=0)
    p10_med = np.percentile(medicare, 10, axis=0)
    p90_med = np.percentile(medicare, 90, axis=0)
    
    fig13 = go.Figure()
    fig13.add_trace(go.Scatter(x=years[2:], y=median_med[2:], fill=None, mode='lines', line=dict(color="blue", width=4), name=f'median {name}'))
    fig13.add_trace(go.Scatter(x=years[2:], y=p10_med[2:], fill=None, mode='lines', line_color="red", name=f'10% CL {name}', showlegend=True))
    fig13.add_trace(go.Scatter(x=years[2:], y=p90_med[2:], fill=None, mode='lines', line_color="green", name=f'90% CL {name}', showlegend=True))

    fig13.update_layout(
        title="Medicare Costs", xaxis_title="Year", yaxis=dict(title="AnnualMedicare Costs", range=[0, None]),
        template="plotly_white", hovermode="x unified", height=400
    )
 
   # --- Build Results Layout ---
    results_layout = html.Div([
        html.Div([
            html.H2(f"Success Rate: {success_rate:.2f}%    Avoid Ruin: {avoid_ruin_rate:.2f}%",
                    style={'fontSize': 30, 'color': vanguard_color(success_rate), 'textAlign': 'center'}),

             html.P([
                f"{inputs.nsims:,} simulations • {elapsed:.1f}s",
                html.Br(),
            ], style={'textAlign': 'center', 'color': '#7f8c8d', 'whiteSpace': 'pre-wrap'})
        ], style={'margin': '30px 0'}),

        # Group Median Results
        html.Div([dcc.Graph(figure=fig1)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig4)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig7)], style={'margin': '40px 0'}),

        # MAGI, Travel/Gifting, ROTH Conversions, Medicare Costs
        html.Div([dcc.Graph(figure=fig10)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig11)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig12)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig13)], style={'margin': '40px 0'}),

        # Group 10% CL Results
        html.Div([dcc.Graph(figure=fig2)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig5)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig8)], style={'margin': '40px 0'}),
        
        # Group 90% CL Results
        html.Div([dcc.Graph(figure=fig3)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig6)], style={'margin': '40px 0'}),
        html.Div([dcc.Graph(figure=fig9)], style={'margin': '40px 0'}),
                
    ], style={'maxWidth': '1400px', 'margin': '0 auto'})

    # Return results into main UI + debug-output text separately
    debug_log = sim.debug_log
    return results_layout, "\n".join(debug_log)

# Sync grid → store whenever edited
@callback(
    Output('portfolio-store', 'data'),
    Input('portfolio-grid', 'cellValueChanged'),
    State('portfolio-grid', 'rowData'),
    prevent_initial_call=True
)
def update_portfolio_store(event, grid_data):
    if not grid_data:
        return DEFAULT_ACCOUNTS
    new_accounts = {}
    for row in grid_data:
        name = row["name"]
        # Clean up None values
        clean_row = {
            k: (v if v not in [None, ""] else None)
            for k, v in row.items()
            if k != "name"
        }
        keep_if_none = ["basis", "mandatory_yield", "rmd_factor_table"]
        # Remove None keys that aren't expected
        clean_row = {
            k: v
            for k, v in clean_row.items()
            if v is not None or k in keep_if_none
        }
        new_accounts[name] = clean_row
    return new_accounts

@app.callback(
    Output("setup-store", "data"),
    Input("setup-grid", "rowData"),
)
def update_setup_store(rows):
    return rows

@callback(
    Output("portfolio-status", "children"),
    Input('portfolio-store', 'data'),
)
def update_portfolio_total(store_data):
    if not store_data:
        return "Total Portfolio: $0"
    total = sum((acct.get("balance") or 0) for acct in store_data.values())
    return f"Total Portfolio: ${total:,.0f}  •  {len(store_data)} accounts"


# Add new account
@callback(
    Output('portfolio-grid', 'rowData', allow_duplicate=True),
    Input('add-account-btn', 'n_clicks'),
    State('portfolio-grid', 'rowData'),
    prevent_initial_call=True
)
def add_account(n, current_rows):
    if n == 0: raise PreventUpdate
    new_name = f"New_Account_{len(current_rows)+1}"
    new_row = {
        "name": new_name,
        "balance": 100000,
        "equity": 0.70,
        "bond": 0.30,
        "tax": "traditional",
        "owner": "person1",
        "basis": None,
        "mandatory_yield": None,
        "rmd_factor_table": None
    }
    return current_rows + [new_row]

# Reset to defaults
@callback(
    Output('portfolio-grid', 'rowData', allow_duplicate=True),
    Output('portfolio-store', 'data', allow_duplicate=True),
    Input('reset-portfolio-btn', 'n_clicks'),
    prevent_initial_call=True
)
def reset_portfolio(n):
    if n == 0: raise PreventUpdate
    return [{**v, "name": k} for k, v in DEFAULT_ACCOUNTS.items()], DEFAULT_ACCOUNTS

#adding delete button
app.clientside_callback(
    """
    function (n_clicks, rowData) {
        if (!n_clicks) return rowData;
        const triggeredId = dash_clientside.callback_context.triggered[0].prop_id.split('.')[0];
        if (triggeredId === 'portfolio-grid') {
            const clickedRow = dash_clientside.callback_context.triggered[0].value;
            if (clickedRow && clickedRow.delete) {
                return rowData.filter(r => r.name !== clickedRow.name);
            }
        }
        return rowData;
    }
    """,
    Output('portfolio-grid', 'rowData'),
    Input('portfolio-grid', 'cellRendererData'),
    State('portfolio-grid', 'rowData'),
    prevent_initial_call=True
)

# Toggle the portfolio editor open/closed — works with the div version (no dcc.Collapse)
@callback(
    Output("portfolio-collapse-content", "style"),
    Output("portfolio-collapse-button", "children"),
    Input("portfolio-collapse-button", "n_clicks"),
    State("portfolio-collapse-content", "style"),
    prevent_initial_call=True
)
def toggle_portfolio_collapse(n_clicks, current_style):
    if not n_clicks:
        raise PreventUpdate
    
    if current_style and current_style.get("display") == "block":
        return {"display": "none"}, "Portfolio Editor – Click to Open"
    else:
        return {"display": "block"}, "Portfolio Editor – Click to Close"
    
# Toggle the setup editor open/closed — works with the div version (no dcc.Collapse)
@callback(
    Output("setup-collapse-content", "style"),
    Output("setup-collapse-button", "children"),
    Input("setup-collapse-button", "n_clicks"),
    State("setup-collapse-content", "style"),
    prevent_initial_call=True
)
def toggle_setup_collapse(n_clicks, current_style):
    if not n_clicks:
        raise PreventUpdate
    
    if current_style and current_style.get("display") == "block":
        return {"display": "none"}, "Setup Editor – Click to Open"
    else:
        return {"display": "block"}, "Setup Editor – Click to Close"
    

if __name__ == '__main__':
    app.run(debug=True)
