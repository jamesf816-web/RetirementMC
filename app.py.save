# app.py
from dash import Dash, dcc, html, Input, Output, State, dash_table
from dash.exceptions import PreventUpdate
import pandas as pd
import numpy as np

from engine.simulator import RetirementSimulator
from config.user_input import accounts

# Initialize simulator
sim = RetirementSimulator(n_sims=10000)

# Helper function: build Roth conversions + balances table
def build_roth_debug_table(result, accounts):
    account_paths = result.get("account_paths", {})
    conv_J = result.get("conversion_paths_JEF", np.zeros((sim.n_sims, len(result.get("years", [])))))
    conv_S = result.get("conversion_paths_SEF", np.zeros((sim.n_sims, len(result.get("years", [])))))
    years = result.get("years", [])

    rows = []
    for y in range(min(10, len(years))):
        row = {
            "Year": years[y],
            "JEF Conversion": float(np.median(conv_J[:, y])) if conv_J.size else 0,
            "SEF Conversion": float(np.median(conv_S[:, y])) if conv_S.size else 0
        }
        for acct in accounts.keys():
            if acct in account_paths:
                row[f"{acct} Balance"] = float(np.median(account_paths[acct][:, y]))
            else:
                row[f"{acct} Balance"] = 0
        rows.append(row)

    return pd.DataFrame(rows)

# Initialize Dash app
app = Dash(__name__, assets_folder="assets")

# Layout: vertical stack (inputs on top, results below)
app.layout = html.Div(style={'fontFamily': 'Arial', 'margin': '2%'}, children=[
    html.H1("JEF & SEF Retirement + Roth Conversion Explorer", style={'textAlign': 'center'}),

    # Input controls
    html.Div([
        html.Label("Number of simulations"),
        dcc.Slider(
            id='nsims',
            min=1000,
            max=30000,
            step=5000,
            value=1000,
            tooltip={"placement": "bottom"}
        ),
        html.Br(),

        html.Label("Maximum annual ROTH Conversion"),
        dcc.Input(
            id='max_roth',
            type="number",
            min=0,
            max=500000,
            step=1000,
            value=300000,
        ),
        html.Br(),

        html.Label("Roth conversion strategy"),
        dcc.Dropdown(
            id='tax_strategy',
            options=[
                {'label': 'Fill the 22% bracket (2026 $211.40k MAGI)', 'value': 'fill_22_percent'},
                {'label': 'Fill the 24% bracket (2026 $403.55k MAGI)', 'value': 'fill_24_percent'},
                {'label': 'Fill the 32% bracket (2026 $512.45k MAGI)', 'value': 'fill_32_percent'},
                {'label': 'Fill the 35% bracket (2026 $768.70k MAGI)', 'value': 'fill_35_percent'},
                {'label': 'No conversions', 'value': 'none'},
            ],
            value='fill_24_percent',
            style={"marginBottom": "20px"}
        ),

        html.Label("IRMAA strategy"),
        dcc.Dropdown(
            id='irmaa_strategy',
            options=[
                {'label': 'Stay under IRMAA Tier 1 (2026 $218k MAGI)', 'value': 'irmaa_tier1'},
                {'label': 'Stay under IRMAA Tier 2 (2026 $274k MAGI)', 'value': 'irmaa_tier2'},
                {'label': 'Stay under IRMAA Tier 3 (2026 $342k MAGI)', 'value': 'irmaa_tier3'},
                {'label': 'Stay under IRMAA Tier 3 (2026 $410k MAGI)', 'value': 'irmaa_tier4'},
            ],
            value='irmaa_tier3',
            style={"marginBottom": "20px"}
        ),

        html.Button("Run Simulation", id="run", n_clicks=0),
    ], style={
        "width": "60%",
        "margin": "0 auto",
        "padding": "20px",
        "border": "1px solid #ccc",
        "borderRadius": "10px",
        "backgroundColor": "#f7f7f7"
    }),

    # Results table area
    html.Div(id='results', style={
        "width": "90%",
        "margin": "30px auto"
    }),

    # debug messages
    html.Div(id="debug-output", style={"whiteSpace": "pre-wrap", "color": "red"})

])

# Callback to run simulation and display table
@app.callback(
#    [
    Output('results', 'children'),
#     Output("debug-output", "children")],
    Input('run', 'n_clicks'),
    State('tax_strategy', 'value'),
    State('irmaa_strategy', 'value'),
    State('max_roth', 'value'),
    State('nsims', 'value'),
    prevent_initial_call = True
)
def update_results(n_clicks, tax_strategy, irmaa_strategy, max_roth, nsims):
    if n_clicks is None:
        raise PreventUpdate

    # 1. initialize debug collector properly (NO COMMA!)
    debug_log = []

    # 2. run simulation
    sim.n_sims = nsims
    res = sim.run_simulation(
        tax_strategy=tax_strategy,
        irmaa_strategy=irmaa_strategy,
        max_roth=max_roth,
        return_trajectories=True,
        accounts=accounts,
        debug_log=debug_log     # <-- YOU MUST PASS THIS INTO THE SIMULATION
    )

    # ==================== NEW: CALCULATE SUCCESS RATE ====================
    portfolio_paths = res["portfolio_paths"]        # (n_sims, n_years)
    final_balances = portfolio_paths[:, -1]
    success_threshold = 100_000                     # adjust if you want $0 or $50k etc.
    success_rate = np.mean(final_balances >= success_threshold) * 100

    median_final = np.median(final_balances)
    p10_final = np.percentile(final_balances, 10)
    # =====================================================================

    
    # 3. build table
    df = build_roth_debug_table(res, accounts)
    if df.empty:
        return (
            html.Div("Simulation returned no data.", style={"textAlign": "center"}),
            "\n".join(debug_log)
        )

    cols_to_display = [
        "Year", "SEF Conversion", "SEF_RothIRA Balance", "SEF_TradIRA Balance", "JEF Conversion",
        "JEF_RothIRA Balance", "JEF_TradIRA Balance", "JEF_RolloverIRA Balance", "JEF_TIAA401K Balance"
    ]
    df_display = df[cols_to_display]

    table = dash_table.DataTable(
        columns=[
            {"name": col, "id": col,
             "type": "numeric" if col != "Year" else "text",
             "format": {"specifier": "$,.2f"} if col != "Year" else None}
            for col in cols_to_display
        ],
        data=df_display.to_dict('records'),
        style_table={'overflowX': 'auto', 'maxHeight': '500px', 'overflowY': 'auto'},
        style_cell={'textAlign': 'right', 'minWidth': '100px', 'padding': '5px'},
        style_header={'backgroundColor': '#f1f1f1', 'fontWeight': 'bold'}
    )
    # ==================== NEW: SUCCESS RATE DISPLAY ====================
    success_color = "#27ae60" if success_rate >= 95 else "#e67e22" if success_rate >= 80 else "#c0392b"

    results_display = html.Div([
        html.Div([
            html.H2(f"Success Rate: {success_rate:.1f}%", 
                    style={"fontSize": "42px", "color": success_color, "textAlign": "center", "margin": "20px 0"}),
            html.H4([
                f"Median final portfolio: ${median_final:,.0f}  •  ",
                html.Span(f"10th percentile: ${p10_final:,.0f}", style={"color": "#c0392b" if p10_final < 500000 else "#27ae60"})
            ], style={"textAlign": "center", "color": "#2c3e50"}),
        ], style={"padding": "20px", "backgroundColor": "#f8f9fa", "borderRadius": "10px", "margin": "20px 0"}),

        html.H3("First 10 Years – Median Account Balances & Conversions", style={"marginTop": "40px"}),
        table
    ])
    # =====================================================================
    
    # 4. return both outputs (table + debug text)
    return results_display #, "\n".join(debug_log)

# Run server
if __name__ == '__main__':
    app.run(debug=True)
